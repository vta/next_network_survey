<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Quiz</title>

    <link rel="stylesheet" href="/squarespace-css/normalize.css" type="text/css">



    <link rel="stylesheet" href="tradeoffs.css">

    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script>
        (function(W){
    "use strict";
    var QuestionDefinitions=[];
    var answer_index=0;
    var question_index=0;
    var questions_wrapper=null;
    var results_wrapper=null;
    var main_form;

    function setOrPush(target, val) {
        var result = val;
        if (target) {
            result = [target];
            result.push(val);
        }
        return result;
    }

    function getFormResults(formElement) {
        var formElements = formElement.elements;
        var formParams = {};
        var i=0;
        var elem = null;
        for (i=0; i < formElements.length; i+=1) {
            elem = formElements[i];
            W.console.log(elem, elem.type);
            switch (elem.type) {
            case 'submit':
                break;
            case 'radio':
                if (elem.checked){
                    formParams[elem.name] = elem.value;
                }
                break;
            case 'checkbox':
                if (elem.checked) {
                    formParams[elem.name] = setOrPush(formParams[elem.name], elem.value);
                }
                break;
            default:
                formParams[elem.name] = setOrPush(formParams[elem.name], elem.value);
            }
        }
        return formParams;
    }

    function done(user_answers){
        results_wrapper.innerHTML = JSON.stringify(user_answers, null, ' ');
    }

    function ok(){
        var postData=getFormResults(main_form);

        W.console.log(postData);

        if (main_form.checkValidity()){
            done(postData);
        }
    }

    function addRadioQuestion(o) {
        var question = o.question;
        var answers = o.answers;
        if (answers.length < 2){
            W.console.warn('Malformed question: need at least two answers to a "radio" question.', o);
            return;
        }
        var $frag = $(document.createDocumentFragment());
        var $q_wrapper = $('<div class="question radio"/>');

        $('<p>').text(question).appendTo($frag);

        answers.forEach(function(ans){
            $('<input type="radio"/>').attr({
                id:'a_'+answer_index,
                name: 'q_'+question_index,
                required : 'true',
                value: ans
            }).appendTo($q_wrapper);

            $('<label/>').attr({
                for:'a_'+answer_index
            }).text(ans).appendTo($q_wrapper);

            answer_index+=1;
        });

        question_index+=1;
        $frag.append($q_wrapper);
        $frag.appendTo(questions_wrapper);
    }

    function addCheckboxQuestion(o) {
        var qid = o.id;
        var question = o.question;
        var answers = o.answers;
        if (answers.length < 0){
            W.console.warn('Malformed question: need at least one answer to a "checkbox" question.', o);
            return;
        }

        var $frag = $(document.createDocumentFragment());
        var $q_wrapper = $('<div class="question checkbox"/>');

        $('<p>').text(question).appendTo($frag);

        answers.forEach(function(ans){
            $('<input type="checkbox"/>').attr({
                id:'a_'+answer_index,
                name: qid,
                value: ans
            }).appendTo($q_wrapper);

            $('<label/>').attr({
                for:'a_'+answer_index
            }).text(ans).appendTo($q_wrapper);

            answer_index+=1;
        });
        question_index+=1;

        $frag.append($q_wrapper);
        $frag.appendTo(questions_wrapper);
    }

    function addRangeQuestion(o) {
        var qid = o.id;
        var question = o.question;
        var answers = o.answers;
        var input_vals = {'min':o.scale[0],'max':o.scale[1],'step':1};

        if (answers.length !== 2){
            W.console.warn('Malformed question: need two and only two answers for a "range" question.', o);
            return;
        }

        var $frag = $(document.createDocumentFragment());
        var $q_wrapper = $('<div class="question range"/>');

        $('<label>').attr({
            for:'a_'+answer_index
        }).text(question).appendTo($q_wrapper);




        var $left_option = $('<div>').addClass('left').text(answers[0]).appendTo($q_wrapper);

        var $right_option = $('<div>').addClass('left').text(answers[1]);

        var dl_id = 'q_'+question_index+'_dl';

        var $r_input = $('<input type="range"/>').attr({
            id:'a_'+answer_index,
            name: qid,
            required:true,
            list:dl_id,
            min:input_vals.min,
            max:input_vals.max,
            step:input_vals.step
        }).appendTo($q_wrapper);


        var $dl = $('<datalist/>').attr({ id: dl_id}).appendTo($q_wrapper);
        for (var i = input_vals.min; i <= input_vals.max; i=i + input_vals.step){
            $('<option/>').attr({
                value : i
            }).appendTo($dl);
        }

        $right_option.appendTo($q_wrapper);

        answer_index+=1;
        question_index+=1;

        $frag.append($q_wrapper);
        $frag.appendTo(questions_wrapper);
    }

    function set(response){
        QuestionDefinitions=response['survey'];
        QuestionDefinitions.forEach(function(e) {
            if (e.type === "radio"){
                addRadioQuestion(e);
            } else if(e.type === "range"){
                addRangeQuestion(e);
            } else if(e.type === "checkbox"){
                addCheckboxQuestion(e);
            }
        });
    }

    function init(){
        questions_wrapper=document.getElementById('questions_wrapper');
        results_wrapper= document.getElementById('results_wrapper');
        main_form = document.getElementById('main_form');
        main_form.addEventListener('submit',function(event){
            event.preventDefault();
            ok();
            },false);

        $.ajax({
            url: "questions.json"
        }).done(set);

    }
    W.addEventListener('load',init,false);
})(window);
    </script>
</head>

<body>
    <form id="main_form">
        <div id="questions_wrapper"></div>
        <button id="btn" type="submit">Submit answers and view results</button>
    </form>
    <div id="results_wrapper"></div>

</body>

</html>