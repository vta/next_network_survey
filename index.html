<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Quiz</title>
    <style>
        .question {
            width: 300px;
        }

        .question label {
            display: block;
        }

        .question.range>div {
            width: 25px;
            display: inline-block;
            text-align: center;
        }

        .question.range>input {
            width: 230px;
            margin-left: 10px;
            margin-right: 10px;
        }

        .question.range>input+div {
            float: right;
        }
    </style>
    <script>
        /* based on http://stackoverflow.com/a/18337257/940217 */
(function(W){
    "use strict";
    var QuestionDefinitions=[];
    var answer_index=0;
    var question_index=0;
    var questions_wrapper=null;
    var results_wrapper=null;
    var main_form;

    function ajax(a,b,c){
        c=new XMLHttpRequest();
        c.open('GET',a);
        c.onload=function(){
            if (c.readyState === XMLHttpRequest.DONE) {
                b(c.responseText);
            }
        }
        ;c.send();
    }

    function setOrPush(target, val) {
        var result = val;
        if (target) {
            result = [target];
            result.push(val);
        }
        return result;
    }

    function getFormResults(formElement) {
        var formElements = formElement.elements;
        var formParams = {};
        var i=0;
        var elem = null;
        for (i=0; i < formElements.length; i+=1) {
            elem = formElements[i];
            W.console.log(elem, elem.type);
            switch (elem.type) {
            case 'submit':
                break;
            case 'radio':
                if (elem.checked){
                    formParams[elem.name] = elem.value;
                }
                break;
            case 'checkbox':
                if (elem.checked) {
                    formParams[elem.name] = setOrPush(formParams[elem.name], elem.value);
                }
                break;
            default:
                formParams[elem.name] = setOrPush(formParams[elem.name], elem.value);
            }
        }
        return formParams;
    }

    function done(user_answers){
        results_wrapper.innerHTML = JSON.stringify(user_answers, null, ' ');
    }

    function ok(){
        var postData=getFormResults(main_form);

        W.console.log(postData);

        if (main_form.checkValidity()){
            done(postData);
        }
    }



    function addRadioQuestion(question, answers) {
        if (answers.length < 2){
            W.console.warn('Malformed question: need at least two answers to a "radio" question. Q: %s, A: %s', question, answers.join(','));
            return;
        }
        var frag = document.createDocumentFragment();
        var q_wrapper = document.createElement('div');
        q_wrapper.class = "question radio";

        var q = document.createElement('p');
        q.innerText = question;
        frag.appendChild(q);
        answers.forEach(function(ans){
            var a_input = document.createElement('input');
            var a_label = document.createElement('label');
            a_input.type = 'radio';
            a_input.required=true;
            a_input.name = 'q_'+question_index;
            a_input.value = ans;
            a_input.id='a_'+answer_index;
            a_label.innerText = ans;
            a_label.htmlFor='a_'+answer_index;
            q_wrapper.appendChild(a_input);
            q_wrapper.appendChild(a_label);
            frag.appendChild(q_wrapper);
            answer_index+=1;
        });
        question_index+=1;
        questions_wrapper.appendChild(frag);
    }

        function addCheckboxQuestion(question, answers) {
        if (answers.length < 0){
            W.console.warn('Malformed question: need at least one answer to a "checkbox" question. Q: %s, A: %s', question, answers.join(','));
            return;
        }
        var frag = document.createDocumentFragment();
        var q_wrapper = document.createElement('div');
        q_wrapper.class = "question checkbox";

        var q = document.createElement('p');
        q.innerText = question;
        frag.appendChild(q);
        answers.forEach(function(ans){
            var a_input = document.createElement('input');
            var a_label = document.createElement('label');
            a_input.type = 'checkbox';
            a_input.name = 'q_'+question_index;
            a_input.value = ans;
            a_input.id='a_'+answer_index;
            a_label.innerText = ans;
            a_label.htmlFor='a_'+answer_index;
            q_wrapper.appendChild(a_input);
            q_wrapper.appendChild(a_label);
            frag.appendChild(q_wrapper);
            answer_index+=1;
        });
        question_index+=1;
        questions_wrapper.appendChild(frag);
    }

    function addRangeQuestion(question, answers) {
        if (answers.length !== 2){
            W.console.warn('Malformed question: need two and only two answers for a "range" question. Q: %s, A: %s', question, answers.join(','));
            return;
        }
        var frag = document.createDocumentFragment();
        var q_wrapper = document.createElement('div');
        q_wrapper.className = "question range";

        var a_label = document.createElement('label');
        a_label.innerText = question;
        a_label.htmlFor='a_'+answer_index;
        q_wrapper.appendChild(a_label);

        var choice_1 = document.createElement('div');
        choice_1.innerText = answers[0];
        q_wrapper.appendChild(choice_1);

        var a_input = document.createElement('input');
        var input_vals = {'min':0,'max':10,'step':1};
        var dl = document.createElement('datalist');
        dl.id = 'q_'+question_index+'_dl';
        a_input.type = 'range';
        a_input.required=true;
        a_input.name = 'q_'+question_index;
        a_input.id='a_'+answer_index;
        a_input.min=input_vals.min;
        a_input.max=input_vals.max;
        a_input.step=input_vals.step;
        a_input.setAttribute('list',dl.id);
        var i = input_vals.min;
        var opt = null;
        while(i <= input_vals.max){
            opt = document.createElement('option');
            opt.value=i;
            dl.appendChild(opt);
            i = i + input_vals.step;
        }
        q_wrapper.appendChild(a_input);
        q_wrapper.appendChild(dl);

        var choice_2 = document.createElement('div');
        choice_2.innerText = answers[1];
        q_wrapper.appendChild(choice_2);

        frag.appendChild(q_wrapper);
        answer_index+=1;

        question_index+=1;
        questions_wrapper.appendChild(frag);
    }

    function set(response){
        QuestionDefinitions=JSON.parse(response);
        QuestionDefinitions.forEach(function(e) {
            if (e.type === "radio"){
                addRadioQuestion(e.question, e.answers);
            } else if(e.type === "range"){
                addRangeQuestion(e.question, e.answers);
            } else if(e.type === "checkbox"){
                addCheckboxQuestion(e.question, e.answers);
            }
        });
    }

    function init(){
        questions_wrapper=document.getElementById('questions_wrapper');
        results_wrapper= document.getElementById('results_wrapper');
        main_form = document.getElementById('main_form');
        main_form.addEventListener('submit',function(event){
            event.preventDefault();
            ok();
            },false);
        ajax('questions.js',set);
    }
    W.addEventListener('load',init,false);
})(window);
    </script>
</head>

<body>
    <form id="main_form">
        <div id="questions_wrapper"></div>
        <button id="btn" type="submit">OK</button>
    </form>
    <div id="results_wrapper"></div>
</body>

</html>